<!DOCTYPE html>
<html>
<head>
    <title>压力传感器数据监控</title>
    <!-- 引入 mqtt.js 库 -->
    <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
    <!-- 引入 Chart.js 用于绘制图表 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f5f7fa;
            --card-bg: white;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border-color: #bdc3c7;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--light-bg);
            color: var(--text-primary);
        }
        
        .container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        @media (min-width: 768px) {
            .container {
                grid-template-columns: 350px 1fr;
            }
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        
        h1, h2, h3 {
            margin-top: 0;
            color: var(--text-primary);
        }
        
        h1 {
            grid-column: 1 / -1;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }
        
        .config-section .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .button-group {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        #connectBtn {
            background-color: var(--secondary-color);
            color: white;
        }
        
        #connectBtn:hover {
            background-color: #27ae60;
        }
        
        #disconnectBtn {
            background-color: var(--danger-color);
            color: white;
            display: none;
        }
        
        #disconnectBtn:hover {
            background-color: #c0392b;
        }
        
        #clearDataBtn {
            background-color: var(--warning-color);
            color: white;
            margin-top: 15px;
        }
        
        #clearDataBtn:hover {
            background-color: #e67e22;
        }
        
        #status {
            padding: 10px;
            border-radius: 5px;
            margin: 15px 0;
            font-weight: 500;
            background-color: #f1c40f;
            color: var(--text-primary);
        }
        
        #status.connected {
            background-color: var(--secondary-color);
            color: white;
        }
        
        #status.disconnected {
            background-color: var(--danger-color);
            color: white;
        }
        
        .data-display {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        
        .data-card {
            padding: 15px;
            border-radius: 8px;
            background-color: var(--light-bg);
            text-align: center;
        }
        
        .data-card h3 {
            margin-bottom: 10px;
            color: var(--text-secondary);
            font-size: 16px;
        }
        
        .data-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .pressure-value {
            color: var(--primary-color);
        }
        
        .battery-value {
            color: var(--secondary-color);
        }
        
        .battery-indicator {
            height: 10px;
            background-color: #eee;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .battery-level {
            height: 100%;
            background-color: var(--secondary-color);
            transition: width 0.3s ease;
        }
        
        .battery-level.low {
            background-color: var(--warning-color);
        }
        
        .battery-level.critical {
            background-color: var(--danger-color);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        #messages {
            margin-top: 20px;
            padding: 15px;
            max-height: 200px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--light-bg);
            overflow-y: auto;
            font-size: 14px;
        }
        
        .message {
            margin: 5px 0;
            padding: 8px;
            background-color: white;
            border-radius: 4px;
            border-left: 3px solid var(--primary-color);
        }
        
        .message.error {
            border-left-color: var(--danger-color);
        }
        
        .message .time {
            color: var(--text-secondary);
            font-size: 12px;
            margin-bottom: 3px;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-tachometer-alt"></i> 压力传感器数据监控</h1>
        
        <!-- 配置区域 -->
        <div class="card config-section">
            <h2>连接配置</h2>
            
            <div class="form-group">
                <label for="protocol">协议</label>
                <select id="protocol">
                    <option value="ws">ws (未加密)</option>
                    <option value="wss">wss (加密)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="host">服务器地址</label>
                <input type="text" id="host" value="broker.emqx.io" placeholder="例如: broker.emqx.io 或 IP地址">
            </div>
            
            <div class="form-group">
                <label for="port">端口号</label>
                <input type="number" id="port" value="8083" placeholder="例如: 8083 或 8084">
            </div>
            
            <div class="form-group">
                <label for="topic">订阅主题</label>
                <input type="text" id="topic" value="Klarity/250011/data" placeholder="例如: Klarity/250011/data">
            </div>
            
            <div class="form-group">
                <label for="username">用户名 (可选)</label>
                <input type="text" id="username" placeholder="如果服务器需要认证">
            </div>
            
            <div class="form-group">
                <label for="password">密码 (可选)</label>
                <input type="password" id="password" placeholder="如果服务器需要认证">
            </div>
            
            <div class="button-group">
                <button id="connectBtn"><i class="fas fa-plug"></i> 连接</button>
                <button id="disconnectBtn"><i class="fas fa-unplug"></i> 断开连接</button>
            </div>
            
            <div id="status">未连接</div>
            
            <!-- 数据显示区域 -->
            <div class="data-display">
                <div class="data-card">
                    <h3>当前压力值</h3>
                    <div class="data-value pressure-value" id="currentPressure">--</div>
                    <div class="unit">单位 (0-1000)</div>
                </div>
                
                <div class="data-card">
                    <h3>电池电量</h3>
                    <div class="data-value battery-value" id="currentBattery">--</div>
                    <div class="unit">百分比 (%)</div>
                    <div class="battery-indicator">
                        <div class="battery-level" id="batteryLevel" style="width: 0%"></div>
                    </div>
                </div>
                
                <button id="clearDataBtn"><i class="fas fa-trash"></i> 清空压力数据</button>
            </div>
        </div>
        
        <!-- 图表和消息区域 -->
        <div class="card">
            <h2>压力数据趋势</h2>
            <div class="chart-container">
                <canvas id="pressureChart"></canvas>
            </div>
            
            <h3>消息日志</h3>
            <div id="messages"></div>
        </div>
    </div>

    <script>
        let client = null;
        let pressureChart = null;
        let pressureData = []; // 存储压力数据，最多100个
        const MAX_DATA_POINTS = 100; // 数据窗口大小
        
        // 获取DOM元素
        const protocolSelect = document.getElementById('protocol');
        const hostInput = document.getElementById('host');
        const portInput = document.getElementById('port');
        const topicInput = document.getElementById('topic');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const statusDiv = document.getElementById('status');
        const messagesDiv = document.getElementById('messages');
        const currentPressureEl = document.getElementById('currentPressure');
        const currentBatteryEl = document.getElementById('currentBattery');
        const batteryLevelEl = document.getElementById('batteryLevel');
        
        // 初始化图表
        function initChart() {
            const ctx = document.getElementById('pressureChart').getContext('2d');
            
            pressureChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], // 时间标签
                    datasets: [{
                        label: '压力值',
                        data: [],
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        pointRadius: 3,
                        pointBackgroundColor: '#3498db',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '时间'
                            },
                            ticks: {
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '压力值'
                            },
                            min: 0,
                            max: 1000,
                            ticks: {
                                stepSize: 200
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    return `时间: ${tooltipItems[0].label}`;
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 200
                    }
                }
            });
        }
        
        // 更新图表数据
        function updateChart(pressureValue) {
            const now = new Date();
            const timeLabel = `${now.getMinutes()}:${now.getSeconds().toString().padStart(2, '0')}`;
            
            // 添加新数据
            pressureData.push({
                value: pressureValue,
                time: timeLabel
            });
            
            // 保持数据窗口大小为100
            if (pressureData.length > MAX_DATA_POINTS) {
                pressureData.shift(); // 移除最旧的数据
            }
            
            // 更新图表
            pressureChart.data.labels = pressureData.map(item => item.time);
            pressureChart.data.datasets[0].data = pressureData.map(item => item.value);
            pressureChart.update();
        }
        
        // 清空图表数据
        function clearChartData() {
            pressureData = [];
            pressureChart.data.labels = [];
            pressureChart.data.datasets[0].data = [];
            pressureChart.update();
            addMessage('系统消息', '压力数据已清空', false);
        }
        
        // 连接到MQTT服务器
        function connect() {
            // 验证输入
            if (!hostInput.value || !portInput.value || !topicInput.value) {
                alert('请填写服务器地址、端口号和订阅主题');
                return;
            }
            
            // 构建连接URL
            const protocol = protocolSelect.value;
            const host = hostInput.value;
            const port = portInput.value;
            const topic = topicInput.value;
            const url = `${protocol}://${host}:${port}/mqtt`;
            
            // 连接选项
            const options = {};
            if (usernameInput.value) options.username = usernameInput.value;
            if (passwordInput.value) options.password = passwordInput.value;
            
            // 连接到服务器
            try {
                client = mqtt.connect(url, options);
                
                // 连接成功回调
                client.on('connect', () => {
                    statusDiv.textContent = `已连接到: ${url}`;
                    statusDiv.className = 'connected';
                    connectBtn.style.display = 'none';
                    disconnectBtn.style.display = 'inline-block';
                    addMessage('系统消息', `已连接到服务器: ${url}`, false);
                    
                    // 订阅主题
                    client.subscribe(topic, (err) => {
                        if (!err) {
                            addMessage('系统消息', `已成功订阅主题: ${topic}`, false);
                        } else {
                            addMessage('错误', `订阅主题失败: ${err.message}`, true);
                            console.error('订阅失败:', err);
                        }
                    });
                });
                
                // 接收消息回调
                client.on('message', (receivedTopic, message) => {
                    try {
                        // 解析JSON数据
                        const data = JSON.parse(message.toString());
                        
                        // 验证数据格式
                        if (typeof data.PRS === 'number' && typeof data.BAT === 'number') {
                            // 更新显示
                            updateDataDisplay(data.PRS, data.BAT);
                            updateChart(data.PRS);
                            addMessage(receivedTopic, `压力: ${data.PRS}, 电池: ${data.BAT}%`, false);
                        } else {
                            addMessage('数据格式错误', `接收到的数据格式不正确: ${message.toString()}`, true);
                        }
                    } catch (err) {
                        addMessage('数据解析错误', `无法解析消息: ${message.toString()}, 错误: ${err.message}`, true);
                    }
                });
                
                // 连接错误回调
                client.on('error', (err) => {
                    addMessage('连接错误', err.message, true);
                    console.error('连接错误:', err);
                    disconnect();
                });
                
                // 断开连接回调
                client.on('close', () => {
                    statusDiv.textContent = '连接已断开';
                    statusDiv.className = 'disconnected';
                    connectBtn.style.display = 'inline-block';
                    disconnectBtn.style.display = 'none';
                    addMessage('系统消息', '连接已断开', false);
                });
                
            } catch (err) {
                addMessage('错误', err.message, true);
                console.error('连接过程出错:', err);
            }
        }
        
        // 断开连接
        function disconnect() {
            if (client && client.connected) {
                client.end();
                client = null;
            }
        }
        
        // 更新数据显示
        function updateDataDisplay(pressure, battery) {
            // 更新压力显示
            currentPressureEl.textContent = pressure;
            
            // 更新电池显示
            currentBatteryEl.textContent = `${battery}%`;
            batteryLevelEl.style.width = `${battery}%`;
            
            // 根据电池电量设置不同颜色
            if (battery < 20) {
                batteryLevelEl.className = 'battery-level critical';
            } else if (battery < 50) {
                batteryLevelEl.className = 'battery-level low';
            } else {
                batteryLevelEl.className = 'battery-level';
            }
        }
        
        // 添加消息到日志
        function addMessage(topic, content, isError = false) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isError ? 'error' : ''}`;
            
            const time = new Date().toLocaleString();
            
            messageElement.innerHTML = `
                <span class="time">${time} - ${topic}</span>
                <span class="content">${content}</span>
            `;
            
            messagesDiv.prepend(messageElement);
            
            // 限制日志数量，只保留最新的50条
            if (messagesDiv.children.length > 50) {
                messagesDiv.removeChild(messagesDiv.lastChild);
            }
        }
        
        // 事件监听
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        clearDataBtn.addEventListener('click', clearChartData);
        
        // 页面加载完成后初始化图表并自动连接（如果表单有默认值）
        window.addEventListener('load', () => {
            try {
                initChart();
                // 自动连接到 MQTT 服务器
                connect();
            } catch (err) {
                // 在消息日志中记录错误，但不要阻止页面渲染
                addMessage('自动连接错误', err.message || String(err), true);
                console.error('自动连接过程中出错:', err);
            }
        });
    </script>
</body>
</html>
